                                      1 ;-------------------------------------------------------------------------------
                                      2 ;
                                      3 ; GBT Player v2.1.3
                                      4 ;
                                      5 ; SPDX-License-Identifier: MIT
                                      6 ;
                                      7 ; Copyright (c) 2009-2020, Antonio Niño Díaz <antonio_nd@outlook.com>
                                      8 ;
                                      9 ;-------------------------------------------------------------------------------
                                     10 
                           00FF10    11 	.NR10 = 0xFF10
                           00FF11    12 	.NR11 = 0xFF11
                           00FF12    13 	.NR12 = 0xFF12
                           00FF13    14 	.NR13 = 0xFF13
                           00FF14    15 	.NR14 = 0xFF14
                           00FF16    16 	.NR21 = 0xFF16
                           00FF17    17 	.NR22 = 0xFF17
                           00FF18    18 	.NR23 = 0xFF18
                           00FF19    19 	.NR24 = 0xFF19
                           00FF1A    20 	.NR30 = 0xFF1A
                           00FF1B    21 	.NR31 = 0xFF1B
                           00FF1C    22 	.NR32 = 0xFF1C
                           00FF1D    23 	.NR33 = 0xFF1D
                           00FF1E    24 	.NR34 = 0xFF1E
                           00FF20    25 	.NR41 = 0xFF20
                           00FF21    26 	.NR42 = 0xFF21
                           00FF22    27 	.NR43 = 0xFF22
                           00FF23    28 	.NR44 = 0xFF23
                           00FF24    29 	.NR50 = 0xFF24
                           00FF25    30 	.NR51 = 0xFF25
                           00FF26    31 	.NR52 = 0xFF26
                                     32 
                                     33 ;-------------------------------------------------------------------------------
                                     34 
                                     35 	.area	_CODE_1
                                     36 
                                     37 ;-------------------------------------------------------------------------------
                                     38 
      000000                         39 gbt_wave: ; 8 sounds
      000000 A5 D7 C9 E1 BC 9A 76    40 	.DB	0xA5,0xD7,0xC9,0xE1,0xBC,0x9A,0x76,0x31,0x0C,0xBA,0xDE,0x60,0x1B,0xCA,0x03,0x93 ; random :P
             31 0C BA DE 60 1B CA
             03 93
      000010 F0 E1 D2 C3 B4 A5 96    41 	.DB	0xF0,0xE1,0xD2,0xC3,0xB4,0xA5,0x96,0x87,0x78,0x69,0x5A,0x4B,0x3C,0x2D,0x1E,0x0F
             87 78 69 5A 4B 3C 2D
             1E 0F
      000020 FD EC DB CA B9 A8 97    42 	.DB	0xFD,0xEC,0xDB,0xCA,0xB9,0xA8,0x97,0x86,0x79,0x68,0x57,0x46,0x35,0x24,0x13,0x02 ; little up-downs
             86 79 68 57 46 35 24
             13 02
      000030 DE FE DC BA 9A A9 87    43 	.DB	0xDE,0xFE,0xDC,0xBA,0x9A,0xA9,0x87,0x77,0x88,0x87,0x65,0x56,0x54,0x32,0x10,0x12
             77 88 87 65 56 54 32
             10 12
      000040 AB CD EF ED CB A0 12    44 	.DB	0xAB,0xCD,0xEF,0xED,0xCB,0xA0,0x12,0x3E,0xDC,0xBA,0xBC,0xDE,0xFE,0xDC,0x32,0x10 ; triangular broken
             3E DC BA BC DE FE DC
             32 10
      000050 FF EE DD CC BB AA 99    45 	.DB	0xFF,0xEE,0xDD,0xCC,0xBB,0xAA,0x99,0x88,0x77,0x66,0x55,0x44,0x33,0x22,0x11,0x00 ; triangular
             88 77 66 55 44 33 22
             11 00
      000060 FF FF FF FF FF FF FF    46 	.DB	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 ; square 50%
             FF 00 00 00 00 00 00
             00 00
      000070 79 BC DE EF FF EE DC    47 	.DB	0x79,0xBC,0xDE,0xEF,0xFF,0xEE,0xDC,0xB9,0x75,0x43,0x21,0x10,0x00,0x11,0x23,0x45 ; sine
             B9 75 43 21 10 00 11
             23 45
                                     48 
      000080                         49 gbt_noise: ; 16 sounds
                                     50 	; 7 bit
      000080 5F 5B 4B 2F 3B 58 1F    51 	.DB	0x5F,0x5B,0x4B,0x2F,0x3B,0x58,0x1F,0x0F
             0F
                                     52 	; 15 bit
      000088 90 80 70 50 00          53 	.DB	0x90,0x80,0x70,0x50,0x00
      00008D 67 63 53                54 	.DB	0x67,0x63,0x53
                                     55 
      000090                         56 gbt_frequencies:
      000090 2C 00 9C 00 06 01 6B    57 	.DW	  44,  156,  262,  363,  457,  547,  631,  710,  786,  854,  923,  986
             01 C9 01 23 02 77 02
             C6 02 12 03 56 03 9B
             03 DA 03
      0000A8 16 04 4E 04 83 04 B5    58 	.DW	1046, 1102, 1155, 1205, 1253, 1297, 1339, 1379, 1417, 1452, 1486, 1517
             04 E5 04 11 05 3B 05
             63 05 89 05 AC 05 CE
             05 ED 05
      0000C0 0A 06 27 06 42 06 5B    59 	.DW	1546, 1575, 1602, 1627, 1650, 1673, 1694, 1714, 1732, 1750, 1767, 1783
             06 72 06 89 06 9E 06
             B2 06 C4 06 D6 06 E7
             06 F7 06
      0000D8 06 07 14 07 21 07 2D    60 	.DW	1798, 1812, 1825, 1837, 1849, 1860, 1871, 1881, 1890, 1899, 1907, 1915
             07 39 07 44 07 4F 07
             59 07 62 07 6B 07 73
             07 7B 07
      0000F0 83 07 8A 07 90 07 97    61 	.DW	1923, 1930, 1936, 1943, 1949, 1954, 1959, 1964, 1969, 1974, 1978, 1982
             07 9D 07 A2 07 A7 07
             AC 07 B1 07 B6 07 BA
             07 BE 07
      000108 C1 07 C4 07 C8 07 CB    62 	.DW	1985, 1988, 1992, 1995, 1998, 2001, 2004, 2006, 2009, 2011, 2013, 2015
             07 CE 07 D1 07 D4 07
             D6 07 D9 07 DB 07 DD
             07 DF 07
                                     63 
                                     64 ;-------------------------------------------------------------------------------
                                     65 
      000120                         66 _gbt_get_freq_from_index: ; a = index, bc = returned freq
      000120 21r90r00                67 	ld	hl,#gbt_frequencies
      000123 4F                      68 	ld	c,a
      000124 06 00                   69 	ld	b,#0
      000126 09                      70 	add	hl,bc
      000127 09                      71 	add	hl,bc
      000128 4E                      72 	ld	c,(hl)
      000129 23                      73 	inc	hl
      00012A 46                      74 	ld	b,(hl)
      00012B C9                      75 	ret
                                     76 
                                     77 ;-------------------------------------------------------------------------------
                                     78 ;---------------------------------- Channel 1 ----------------------------------
                                     79 ;-------------------------------------------------------------------------------
                                     80 
      00012C                         81 gbt_channel_1_handle:: ; de = info
                                     82 
      00012C FAr00r00                83 	ld	a,(gbt_channels_enabled)
      00012F E6 01                   84 	and	a,#0x01
      000131 20 14                   85 	jr	nz,channel1_enabled$
                                     86 
                                     87 	; Channel is disabled. Increment pointer as needed
                                     88 
      000133 1A                      89 	ld	a,(de)
      000134 13                      90 	inc	de
      000135 CB 7F                   91 	bit	7,a
      000137 20 06                   92 	jr	nz,ch1_more_bytes$
      000139 CB 77                   93 	bit	6,a
      00013B 28 09                   94 	jr	z,ch1_no_more_bytes_this_channel$
                                     95 
      00013D 18 06                   96 	jr	ch1_one_more_byte$
                                     97 
      00013F                         98 ch1_more_bytes$:
                                     99 
      00013F 1A                     100 	ld	a,(de)
      000140 13                     101 	inc	de
      000141 CB 7F                  102 	bit	7,a
      000143 28 01                  103 	jr	z,ch1_no_more_bytes_this_channel$
                                    104 
      000145                        105 ch1_one_more_byte$:
                                    106 
      000145 13                     107 	inc	de
                                    108 
      000146                        109 ch1_no_more_bytes_this_channel$:
                                    110 
      000146 C9                     111 	ret
                                    112 
      000147                        113 channel1_enabled$:
                                    114 
                                    115 	; Channel 1 is enabled
                                    116 
      000147 1A                     117 	ld	a,(de)
      000148 13                     118 	inc	de
                                    119 
      000149 CB 7F                  120 	bit	7,a
      00014B 20 24                  121 	jr	nz,ch1_has_frequency$
                                    122 
                                    123 	; Not frequency
                                    124 
      00014D CB 77                  125 	bit	6,a
      00014F 20 0E                  126 	jr	nz,ch1_instr_effects$
                                    127 
                                    128 	; Set volume or NOP
                                    129 
      000151 CB 6F                  130 	bit	5,a
      000153 20 01                  131 	jr	nz,ch1_just_set_volume$
                                    132 
                                    133 	; NOP
                                    134 
      000155 C9                     135 	ret
                                    136 
      000156                        137 ch1_just_set_volume$:
                                    138 
                                    139 	; Set volume
                                    140 
      000156 E6 0F                  141 	and	a,#0x0F
      000158 CB 37                  142 	swap	a
      00015A EAr00r00               143 	ld	(gbt_vol+0),a
                                    144 
      00015D 18 4C                  145 	jr	refresh_channel1_regs$
                                    146 
      00015F                        147 ch1_instr_effects$:
                                    148 
                                    149 	; Set instrument and effect
                                    150 
      00015F 47                     151 	ld	b,a ; save byte
                                    152 
      000160 E6 30                  153 	and	a,#0x30
      000162 CB 27                  154 	sla	a
      000164 CB 27                  155 	sla	a
      000166 EAr00r00               156 	ld	(gbt_instr+0),a ; Instrument
                                    157 
      000169 78                     158 	ld	a,b ; restore byte
                                    159 
      00016A E6 0F                  160 	and	a,#0x0F ; a = effect
                                    161 
      00016C CDr2Dr02               162 	call	gbt_channel_1_set_effect
                                    163 
      00016F 18 3A                  164 	jr	refresh_channel1_regs$
                                    165 
      000171                        166 ch1_has_frequency$:
                                    167 
                                    168 	; Has frequency
                                    169 
      000171 E6 7F                  170 	and	a,#0x7F
      000173 EAr00r00               171 	ld	(gbt_arpeggio_freq_index+0*3),a
                                    172 	; This destroys hl and a. Returns freq in bc
      000176 CDr20r01               173 	call	_gbt_get_freq_from_index
                                    174 
      000179 79                     175 	ld	a,c
      00017A EAr00r00               176 	ld	(gbt_freq+0*2+0),a
      00017D 78                     177 	ld	a,b
      00017E EAr01r00               178 	ld	(gbt_freq+0*2+1),a ; Get frequency
                                    179 
      000181 1A                     180 	ld	a,(de)
      000182 13                     181 	inc	de
                                    182 
      000183 CB 7F                  183 	bit	7,a
      000185 20 14                  184 	jr	nz,ch1_freq_instr_and_effect$
                                    185 
                                    186 	; Freq + Instr + Volume
                                    187 
      000187 47                     188 	ld	b,a ; save byte
                                    189 
      000188 E6 30                  190 	and	a,#0x30
      00018A CB 27                  191 	sla	a
      00018C CB 27                  192 	sla	a
      00018E EAr00r00               193 	ld	(gbt_instr+0),a ; Instrument
                                    194 
      000191 78                     195 	ld	a,b ; restore byte
                                    196 
      000192 E6 0F                  197 	and	a,#0x0F ; a = volume
                                    198 
      000194 CB 37                  199 	swap	a
      000196 EAr00r00               200 	ld	(gbt_vol+0),a
                                    201 
      000199 18 10                  202 	jr	refresh_channel1_regs$
                                    203 
      00019B                        204 ch1_freq_instr_and_effect$:
                                    205 
                                    206 	; Freq + Instr + Effect
                                    207 
      00019B 47                     208 	ld	b,a ; save byte
                                    209 
      00019C E6 30                  210 	and	a,#0x30
      00019E CB 27                  211 	sla	a
      0001A0 CB 27                  212 	sla	a
      0001A2 EAr00r00               213 	ld	(gbt_instr+0),a ; Instrument
                                    214 
      0001A5 78                     215 	ld	a,b ; restore byte
                                    216 
      0001A6 E6 0F                  217 	and	a,#0x0F ; a = effect
                                    218 
      0001A8 CDr2Dr02               219 	call	gbt_channel_1_set_effect
                                    220 
                                    221 	;jr	refresh_channel1_regs$
                                    222 
      0001AB                        223 refresh_channel1_regs$:
                                    224 
                                    225 	; fall through!
                                    226 
                                    227 ; -----------------
                                    228 
      0001AB                        229 channel1_refresh_registers:
                                    230 
      0001AB AF                     231 	xor	a,a
      0001AC EA 10 FF               232 	ld	(#.NR10),a
      0001AF FAr00r00               233 	ld	a,(gbt_instr+0)
      0001B2 EA 11 FF               234 	ld	(#.NR11),a
      0001B5 FAr00r00               235 	ld	a,(gbt_vol+0)
      0001B8 EA 12 FF               236 	ld	(#.NR12),a
      0001BB FAr00r00               237 	ld	a,(gbt_freq+0*2+0)
      0001BE EA 13 FF               238 	ld	(#.NR13),a
      0001C1 FAr01r00               239 	ld	a,(gbt_freq+0*2+1)
      0001C4 F6 80                  240 	or	a,#0x80 ; start
      0001C6 EA 14 FF               241 	ld	(#.NR14),a
                                    242 
      0001C9 C9                     243 	ret
                                    244 
                                    245 ; ------------------
                                    246 
      0001CA                        247 channel1_update_effects: ; returns 1 in a if it is needed to update sound registers
                                    248 
                                    249 	; Cut note
                                    250 	; --------
                                    251 
      0001CA FAr00r00               252 	ld	a,(gbt_cut_note_tick+0)
      0001CD 21r00r00               253 	ld	hl,#gbt_ticks_elapsed
      0001D0 BE                     254 	cp	a,(hl)
      0001D1 C2rE1r01               255 	jp	nz,ch1_dont_cut$
                                    256 
      0001D4 3D                     257 	dec	a ; a = 0xFF
      0001D5 EAr00r00               258 	ld	(gbt_cut_note_tick+0),a ; disable cut note
                                    259 
      0001D8 AF                     260 	xor	a,a ; vol = 0
      0001D9 EA 12 FF               261 	ld	(#.NR12),a
      0001DC 3E 80                  262 	ld	a,#0x80 ; start
      0001DE EA 14 FF               263 	ld	(#.NR14),a
                                    264 
      0001E1                        265 ch1_dont_cut$:
                                    266 
                                    267 	; Arpeggio
                                    268 	; --------
                                    269 
      0001E1 FAr00r00               270 	ld	a,(gbt_arpeggio_enabled+0)
      0001E4 A7                     271 	and	a,a
      0001E5 C8                     272 	ret	z ; a is 0, return 0
                                    273 
                                    274 	; If enabled arpeggio, handle it
                                    275 
      0001E6 FAr00r00               276 	ld	a,(gbt_arpeggio_tick+0)
      0001E9 A7                     277 	and	a,a
      0001EA 20 14                  278 	jr	nz,ch1_not_tick_0$
                                    279 
                                    280 	; Tick 0 - Set original frequency
                                    281 
      0001EC FAr00r00               282 	ld	a,(gbt_arpeggio_freq_index+0*3+0)
                                    283 
      0001EF CDr20r01               284 	call	_gbt_get_freq_from_index
                                    285 
      0001F2 79                     286 	ld	a,c
      0001F3 EAr00r00               287 	ld	(gbt_freq+0*2+0),a
      0001F6 78                     288 	ld	a,b
      0001F7 EAr01r00               289 	ld	(gbt_freq+0*2+1),a ; Set frequency
                                    290 
      0001FA 3E 01                  291 	ld	a,#1
      0001FC EAr00r00               292 	ld	(gbt_arpeggio_tick+0),a
                                    293 
      0001FF C9                     294 	ret ; ret 1
                                    295 
      000200                        296 ch1_not_tick_0$:
                                    297 
      000200 FE 01                  298 	cp	a,#1
      000202 20 15                  299 	jr	nz,ch1_not_tick_1$
                                    300 
                                    301 	; Tick 1
                                    302 
      000204 FAr01r00               303 	ld	a,(gbt_arpeggio_freq_index+0*3+1)
                                    304 
      000207 CDr20r01               305 	call	_gbt_get_freq_from_index
                                    306 
      00020A 79                     307 	ld	a,c
      00020B EAr00r00               308 	ld	(gbt_freq+0*2+0),a
      00020E 78                     309 	ld	a,b
      00020F EAr01r00               310 	ld	(gbt_freq+0*2+1),a ; Set frequency
                                    311 
      000212 3E 02                  312 	ld	a,#2
      000214 EAr00r00               313 	ld	(gbt_arpeggio_tick+0),a
                                    314 
      000217 3D                     315 	dec	a
      000218 C9                     316 	ret ; ret 1
                                    317 
      000219                        318 ch1_not_tick_1$:
                                    319 
                                    320 	; Tick 2
                                    321 
      000219 FAr02r00               322 	ld	a,(gbt_arpeggio_freq_index+0*3+2)
                                    323 
      00021C CDr20r01               324 	call	_gbt_get_freq_from_index
                                    325 
      00021F 79                     326 	ld	a,c
      000220 EAr00r00               327 	ld	(gbt_freq+0*2+0),a
      000223 78                     328 	ld	a,b
      000224 EAr01r00               329 	ld	(gbt_freq+0*2+1),a ; Set frequency
                                    330 
      000227 AF                     331 	xor	a,a
      000228 EAr00r00               332 	ld	(gbt_arpeggio_tick+0),a
                                    333 
      00022B 3C                     334 	inc	a
      00022C C9                     335 	ret ; ret 1
                                    336 
                                    337 ; -----------------
                                    338 
                                    339 ; returns a = 1 if needed to update registers, 0 if not
      00022D                        340 gbt_channel_1_set_effect: ; a = effect, de = pointer to data.
                                    341 
      00022D 21r3Br02               342 	ld	hl,#gbt_ch1_jump_table$
      000230 4F                     343 	ld	c,a
      000231 06 00                  344 	ld	b,#0
      000233 09                     345 	add	hl,bc
      000234 09                     346 	add	hl,bc
                                    347 
      000235 2A                     348 	ld	a,(hl+)
      000236 66                     349 	ld	h,(hl)
      000237 6F                     350 	ld	l,a
                                    351 
      000238 1A                     352 	ld	a,(de) ; load args
      000239 13                     353 	inc	de
                                    354 
      00023A E9                     355 	jp	(hl)
                                    356 
      00023B                        357 gbt_ch1_jump_table$:
      00023Br5Br02                  358 	.DW	gbt_ch1_pan$
      00023Dr62r02                  359 	.DW	gbt_ch1_arpeggio$
      00023Fr7Dr02                  360 	.DW	gbt_ch1_cut_note$
      000241r09r06                  361 	.DW	gbt_ch1234_nop
      000243r09r06                  362 	.DW	gbt_ch1234_nop
      000245r09r06                  363 	.DW	gbt_ch1234_nop
      000247r09r06                  364 	.DW	gbt_ch1234_nop
      000249r09r06                  365 	.DW	gbt_ch1234_nop
      00024Br0Br06                  366 	.DW	gbt_ch1234_jump_pattern
      00024Dr1Cr06                  367 	.DW	gbt_ch1234_jump_position
      00024Fr2Er06                  368 	.DW	gbt_ch1234_speed
      000251r09r06                  369 	.DW	gbt_ch1234_nop
      000253r09r06                  370 	.DW	gbt_ch1234_nop
      000255r09r06                  371 	.DW	gbt_ch1234_nop
      000257r09r06                  372 	.DW	gbt_ch1234_nop
      000259r09r06                  373 	.DW	gbt_ch1234_nop
                                    374 
      00025B                        375 gbt_ch1_pan$:
      00025B E6 11                  376 	and	a,#0x11
      00025D EAr00r00               377 	ld	(gbt_pan+0),a
      000260 AF                     378 	xor	a,a
      000261 C9                     379 	ret ; ret 0 do not update registers, only NR51 at end.
                                    380 
      000262                        381 gbt_ch1_arpeggio$:
      000262 47                     382 	ld	b,a ; b = params
                                    383 
      000263 21r00r00               384 	ld	hl,#gbt_arpeggio_freq_index+0*3
      000266 4E                     385 	ld	c,(hl) ; c = base index
      000267 23                     386 	inc	hl
                                    387 
      000268 78                     388 	ld	a,b
      000269 CB 37                  389 	swap	a
      00026B E6 0F                  390 	and	a,#0x0F
      00026D 81                     391 	add	a,c
                                    392 
      00026E 22                     393 	ld	(hl+),a ; save first increment
                                    394 
      00026F 78                     395 	ld	a,b
      000270 E6 0F                  396 	and	a,#0x0F
      000272 81                     397 	add	a,c
                                    398 
      000273 77                     399 	ld	(hl),a ; save second increment
                                    400 
      000274 3E 01                  401 	ld	a,#1
      000276 EAr00r00               402 	ld	(gbt_arpeggio_enabled+0),a
      000279 EAr00r00               403 	ld	(gbt_arpeggio_tick+0),a
                                    404 
      00027C C9                     405 	ret ; ret 1
                                    406 
      00027D                        407 gbt_ch1_cut_note$:
      00027D EAr00r00               408 	ld	(gbt_cut_note_tick+0),a
      000280 AF                     409 	xor	a,a ; ret 0
      000281 C9                     410 	ret
                                    411 
                                    412 ;-------------------------------------------------------------------------------
                                    413 ;---------------------------------- Channel 2 ----------------------------------
                                    414 ;-------------------------------------------------------------------------------
                                    415 
      000282                        416 gbt_channel_2_handle:: ; de = info
                                    417 
      000282 FAr00r00               418 	ld	a,(gbt_channels_enabled)
      000285 E6 02                  419 	and	a,#0x02
      000287 20 14                  420 	jr	nz,channel2_enabled$
                                    421 
                                    422 	; Channel is disabled. Increment pointer as needed
                                    423 
      000289 1A                     424 	ld	a,(de)
      00028A 13                     425 	inc	de
      00028B CB 7F                  426 	bit	7,a
      00028D 20 06                  427 	jr	nz,ch2_more_bytes$
      00028F CB 77                  428 	bit	6,a
      000291 28 09                  429 	jr	z,ch2_no_more_bytes_this_channel$
                                    430 
      000293 18 06                  431 	jr	ch2_one_more_byte$
                                    432 
      000295                        433 ch2_more_bytes$:
                                    434 
      000295 1A                     435 	ld	a,(de)
      000296 13                     436 	inc	de
      000297 CB 7F                  437 	bit	7,a
      000299 28 01                  438 	jr	z,ch2_no_more_bytes_this_channel$
                                    439 
      00029B                        440 ch2_one_more_byte$:
                                    441 
      00029B 13                     442 	inc	de
                                    443 
      00029C                        444 ch2_no_more_bytes_this_channel$:
                                    445 
      00029C C9                     446 	ret
                                    447 
      00029D                        448 channel2_enabled$:
                                    449 
                                    450 	; Channel 2 is enabled
                                    451 
      00029D 1A                     452 	ld	a,(de)
      00029E 13                     453 	inc	de
                                    454 
      00029F CB 7F                  455 	bit	7,a
      0002A1 20 24                  456 	jr	nz,ch2_has_frequency$
                                    457 
                                    458 	; Not frequency
                                    459 
      0002A3 CB 77                  460 	bit	6,a
      0002A5 20 0E                  461 	jr	nz,ch2_instr_effects$
                                    462 
                                    463 	; Set volume or NOP
                                    464 
      0002A7 CB 6F                  465 	bit	5,a
      0002A9 20 01                  466 	jr	nz,ch2_just_set_volume$
                                    467 
                                    468 	; NOP
                                    469 
      0002AB C9                     470 	ret
                                    471 
      0002AC                        472 ch2_just_set_volume$:
                                    473 
                                    474 	; Set volume
                                    475 
      0002AC E6 0F                  476 	and	a,#0x0F
      0002AE CB 37                  477 	swap	a
      0002B0 EAr01r00               478 	ld	(gbt_vol+1),a
                                    479 
      0002B3 18 4C                  480 	jr	refresh_channel2_regs$
                                    481 
      0002B5                        482 ch2_instr_effects$:
                                    483 
                                    484 	; Set instrument and effect
                                    485 
      0002B5 47                     486 	ld	b,a ; save byte
                                    487 
      0002B6 E6 30                  488 	and	a,#0x30
      0002B8 CB 27                  489 	sla	a
      0002BA CB 27                  490 	sla	a
      0002BC EAr01r00               491 	ld	(gbt_instr+1),a ; Instrument
                                    492 
      0002BF 78                     493 	ld	a,b ; restore byte
                                    494 
      0002C0 E6 0F                  495 	and	a,#0x0F ; a = effect
                                    496 
      0002C2 CDr7Fr03               497 	call	gbt_channel_2_set_effect
                                    498 
      0002C5 18 3A                  499 	jr	refresh_channel2_regs$
                                    500 
      0002C7                        501 ch2_has_frequency$:
                                    502 
                                    503 	; Has frequency
                                    504 
      0002C7 E6 7F                  505 	and	a,#0x7F
      0002C9 EAr03r00               506 	ld	(gbt_arpeggio_freq_index+1*3),a
                                    507 	; This destroys hl and a. Returns freq in bc
      0002CC CDr20r01               508 	call	_gbt_get_freq_from_index
                                    509 
      0002CF 79                     510 	ld	a,c
      0002D0 EAr02r00               511 	ld	(gbt_freq+1*2+0),a
      0002D3 78                     512 	ld	a,b
      0002D4 EAr03r00               513 	ld	(gbt_freq+1*2+1),a ; Get frequency
                                    514 
      0002D7 1A                     515 	ld	a,(de)
      0002D8 13                     516 	inc	de
                                    517 
      0002D9 CB 7F                  518 	bit	7,a
      0002DB 20 14                  519 	jr	nz,ch2_freq_instr_and_effect$
                                    520 
                                    521 	; Freq + Instr + Volume
                                    522 
      0002DD 47                     523 	ld	b,a ; save byte
                                    524 
      0002DE E6 30                  525 	and	a,#0x30
      0002E0 CB 27                  526 	sla	a
      0002E2 CB 27                  527 	sla	a
      0002E4 EAr01r00               528 	ld	(gbt_instr+1),a ; Instrument
                                    529 
      0002E7 78                     530 	ld	a,b ; restore byte
                                    531 
      0002E8 E6 0F                  532 	and	a,#0x0F ; a = volume
                                    533 
      0002EA CB 37                  534 	swap	a
      0002EC EAr01r00               535 	ld	(gbt_vol+1),a
                                    536 
      0002EF 18 10                  537 	jr	refresh_channel2_regs$
                                    538 
      0002F1                        539 ch2_freq_instr_and_effect$:
                                    540 
                                    541 	; Freq + Instr + Effect
                                    542 
      0002F1 47                     543 	ld	b,a ; save byte
                                    544 
      0002F2 E6 30                  545 	and	a,#0x30
      0002F4 CB 27                  546 	sla	a
      0002F6 CB 27                  547 	sla	a
      0002F8 EAr01r00               548 	ld	(gbt_instr+1),a ; Instrument
                                    549 
      0002FB 78                     550 	ld	a,b ; restore byte
                                    551 
      0002FC E6 0F                  552 	and	a,#0x0F ; a = effect
                                    553 
      0002FE CDr7Fr03               554 	call	gbt_channel_2_set_effect
                                    555 
                                    556 	;jr	.refresh_channel2_regs
                                    557 
      000301                        558 refresh_channel2_regs$:
                                    559 
                                    560 	; fall through!
                                    561 
                                    562 ; -----------------
                                    563 
      000301                        564 channel2_refresh_registers:
                                    565 
      000301 FAr01r00               566 	ld	a,(gbt_instr+1)
      000304 EA 16 FF               567 	ld	(#.NR21),a
      000307 FAr01r00               568 	ld	a,(gbt_vol+1)
      00030A EA 17 FF               569 	ld	(#.NR22),a
      00030D FAr02r00               570 	ld	a,(gbt_freq+1*2+0)
      000310 EA 18 FF               571 	ld	(#.NR23),a
      000313 FAr03r00               572 	ld	a,(gbt_freq+1*2+1)
      000316 F6 80                  573 	or	a,#0x80 ; start
      000318 EA 19 FF               574 	ld	(#.NR24),a
                                    575 
      00031B C9                     576 	ret
                                    577 
                                    578 ; ------------------
                                    579 
      00031C                        580 channel2_update_effects: ; returns 1 in a if it is needed to update sound regs
                                    581 
                                    582 	; Cut note
                                    583 	; --------
                                    584 
      00031C FAr01r00               585 	ld	a,(gbt_cut_note_tick+1)
      00031F 21r00r00               586 	ld	hl,#gbt_ticks_elapsed
      000322 BE                     587 	cp	a,(hl)
      000323 C2r33r03               588 	jp	nz,ch2_dont_cut$
                                    589 
      000326 3D                     590 	dec	a ; a = 0xFF
      000327 EAr01r00               591 	ld	(gbt_cut_note_tick+1),a ; disable cut note
                                    592 
      00032A AF                     593 	xor	a,a ; vol = 0
      00032B EA 17 FF               594 	ld	(#.NR22),a
      00032E 3E 80                  595 	ld	a,#0x80 ; start
      000330 EA 19 FF               596 	ld	(#.NR24),a
                                    597 
      000333                        598 ch2_dont_cut$:
                                    599 
                                    600 	; Arpeggio
                                    601 	; --------
                                    602 
      000333 FAr01r00               603 	ld	a,(gbt_arpeggio_enabled+1)
      000336 A7                     604 	and	a,a
      000337 C8                     605 	ret	z ; a is 0, return 0
                                    606 
                                    607 	; If enabled arpeggio, handle it
                                    608 
      000338 FAr01r00               609 	ld	a,(gbt_arpeggio_tick+1)
      00033B A7                     610 	and	a,a
      00033C 20 14                  611 	jr	nz,ch2_not_tick_0$
                                    612 
                                    613 	; Tick 0 - Set original frequency
                                    614 
      00033E FAr03r00               615 	ld	a,(gbt_arpeggio_freq_index+1*3+0)
                                    616 
      000341 CDr20r01               617 	call	_gbt_get_freq_from_index
                                    618 
      000344 79                     619 	ld	a,c
      000345 EAr02r00               620 	ld	(gbt_freq+1*2+0),a
      000348 78                     621 	ld	a,b
      000349 EAr03r00               622 	ld	(gbt_freq+1*2+1),a ; Set frequency
                                    623 
      00034C 3E 01                  624 	ld	a,#1
      00034E EAr01r00               625 	ld	(gbt_arpeggio_tick+1),a
                                    626 
      000351 C9                     627 	ret ; ret 1
                                    628 
      000352                        629 ch2_not_tick_0$:
                                    630 
      000352 FE 01                  631 	cp	a,#1
      000354 20 15                  632 	jr	nz,ch2_not_tick_1$
                                    633 
                                    634 	; Tick 1
                                    635 
      000356 FAr04r00               636 	ld	a,(gbt_arpeggio_freq_index+1*3+1)
                                    637 
      000359 CDr20r01               638 	call	_gbt_get_freq_from_index
                                    639 
      00035C 79                     640 	ld	a,c
      00035D EAr02r00               641 	ld	(gbt_freq+1*2+0),a
      000360 78                     642 	ld	a,b
      000361 EAr03r00               643 	ld	(gbt_freq+1*2+1),a ; Set frequency
                                    644 
      000364 3E 02                  645 	ld	a,#2
      000366 EAr01r00               646 	ld	(gbt_arpeggio_tick+1),a
                                    647 
      000369 3D                     648 	dec	a
      00036A C9                     649 	ret ; ret 1
                                    650 
      00036B                        651 ch2_not_tick_1$:
                                    652 
                                    653 	; Tick 2
                                    654 
      00036B FAr05r00               655 	ld	a,(gbt_arpeggio_freq_index+1*3+2)
                                    656 
      00036E CDr20r01               657 	call	_gbt_get_freq_from_index
                                    658 
      000371 79                     659 	ld	a,c
      000372 EAr02r00               660 	ld	(gbt_freq+1*2+0),a
      000375 78                     661 	ld	a,b
      000376 EAr03r00               662 	ld	(gbt_freq+1*2+1),a ; Set frequency
                                    663 
      000379 AF                     664 	xor	a,a
      00037A EAr01r00               665 	ld	(gbt_arpeggio_tick+1),a
                                    666 
      00037D 3C                     667 	inc	a
      00037E C9                     668 	ret ; ret 1
                                    669 
                                    670 ; -----------------
                                    671 
                                    672 ; returns a = 1 if needed to update registers, 0 if not
      00037F                        673 gbt_channel_2_set_effect: ; a = effect, de = pointer to data
                                    674 
      00037F 21r8Dr03               675 	ld	hl,#gbt_ch2_jump_table$
      000382 4F                     676 	ld	c,a
      000383 06 00                  677 	ld	b,#0
      000385 09                     678 	add	hl,bc
      000386 09                     679 	add	hl,bc
                                    680 
      000387 2A                     681 	ld	a,(hl+)
      000388 66                     682 	ld	h,(hl)
      000389 6F                     683 	ld	l,a
                                    684 
      00038A 1A                     685 	ld	a,(de) ; load args
      00038B 13                     686 	inc	de
                                    687 
      00038C E9                     688 	jp	(hl)
                                    689 
      00038D                        690 gbt_ch2_jump_table$:
      00038DrADr03                  691 	.DW	gbt_ch2_pan$
      00038FrB4r03                  692 	.DW	gbt_ch2_arpeggio$
      000391rCFr03                  693 	.DW	gbt_ch2_cut_note$
      000393r09r06                  694 	.DW	gbt_ch1234_nop
      000395r09r06                  695 	.DW	gbt_ch1234_nop
      000397r09r06                  696 	.DW	gbt_ch1234_nop
      000399r09r06                  697 	.DW	gbt_ch1234_nop
      00039Br09r06                  698 	.DW	gbt_ch1234_nop
      00039Dr0Br06                  699 	.DW	gbt_ch1234_jump_pattern
      00039Fr1Cr06                  700 	.DW	gbt_ch1234_jump_position
      0003A1r2Er06                  701 	.DW	gbt_ch1234_speed
      0003A3r09r06                  702 	.DW	gbt_ch1234_nop
      0003A5r09r06                  703 	.DW	gbt_ch1234_nop
      0003A7r09r06                  704 	.DW	gbt_ch1234_nop
      0003A9r09r06                  705 	.DW	gbt_ch1234_nop
      0003ABr09r06                  706 	.DW	gbt_ch1234_nop
                                    707 
      0003AD                        708 gbt_ch2_pan$:
      0003AD E6 22                  709 	and	a,#0x22
      0003AF EAr01r00               710 	ld	(gbt_pan+1),a
      0003B2 AF                     711 	xor	a,a ; ret 0
      0003B3 C9                     712 	ret ; Should not update registers, only NR51 at end.
                                    713 
      0003B4                        714 gbt_ch2_arpeggio$:
      0003B4 47                     715 	ld	b,a ; b = params
                                    716 
      0003B5 21r03r00               717 	ld	hl,#gbt_arpeggio_freq_index+1*3
      0003B8 4E                     718 	ld	c,(hl) ; c = base index
      0003B9 23                     719 	inc	hl
                                    720 
      0003BA 78                     721 	ld	a,b
      0003BB CB 37                  722 	swap	a
      0003BD E6 0F                  723 	and	a,#0x0F
      0003BF 81                     724 	add	a,c
                                    725 
      0003C0 22                     726 	ld	(hl+),a ; save first increment
                                    727 
      0003C1 78                     728 	ld	a,b
      0003C2 E6 0F                  729 	and	a,#0x0F
      0003C4 81                     730 	add	a,c
                                    731 
      0003C5 77                     732 	ld	(hl),a ; save second increment
                                    733 
      0003C6 3E 01                  734 	ld	a,#1
      0003C8 EAr01r00               735 	ld	(gbt_arpeggio_enabled+1),a
      0003CB EAr01r00               736 	ld	(gbt_arpeggio_tick+1),a
                                    737 
      0003CE C9                     738 	ret ; ret 1
                                    739 
      0003CF                        740 gbt_ch2_cut_note$:
      0003CF EAr01r00               741 	ld	(gbt_cut_note_tick+1),a
      0003D2 AF                     742 	xor	a,a ; ret 0
      0003D3 C9                     743 	ret
                                    744 
                                    745 ;-------------------------------------------------------------------------------
                                    746 ;---------------------------------- Channel 3 ----------------------------------
                                    747 ;-------------------------------------------------------------------------------
                                    748 
      0003D4                        749 gbt_channel_3_handle:: ; de = info
                                    750 
      0003D4 FAr00r00               751 	ld	a,(gbt_channels_enabled)
      0003D7 E6 04                  752 	and	a,#0x04
      0003D9 20 14                  753 	jr	nz,channel3_enabled$
                                    754 
                                    755 	; Channel is disabled. Increment pointer as needed
                                    756 
      0003DB 1A                     757 	ld	a,(de)
      0003DC 13                     758 	inc	de
      0003DD CB 7F                  759 	bit	7,a
      0003DF 20 06                  760 	jr	nz,ch3_more_bytes$
      0003E1 CB 77                  761 	bit	6,a
      0003E3 28 09                  762 	jr	z,ch3_no_more_bytes_this_channel$
                                    763 
      0003E5 18 06                  764 	jr	ch3_one_more_byte$
                                    765 
      0003E7                        766 ch3_more_bytes$:
                                    767 
      0003E7 1A                     768 	ld	a,(de)
      0003E8 13                     769 	inc	de
      0003E9 CB 7F                  770 	bit	7,a
      0003EB 28 01                  771 	jr	z,ch3_no_more_bytes_this_channel$
                                    772 
      0003ED                        773 ch3_one_more_byte$:
                                    774 
      0003ED 13                     775 	inc	de
                                    776 
      0003EE                        777 ch3_no_more_bytes_this_channel$:
                                    778 
      0003EE C9                     779 	ret
                                    780 
      0003EF                        781 channel3_enabled$:
                                    782 
                                    783 	; Channel 3 is enabled
                                    784 
      0003EF 1A                     785 	ld	a,(de)
      0003F0 13                     786 	inc	de
                                    787 
      0003F1 CB 7F                  788 	bit	7,a
      0003F3 20 19                  789 	jr	nz,ch3_has_frequency$
                                    790 
                                    791 	; Not frequency
                                    792 
      0003F5 CB 77                  793 	bit	6,a
      0003F7 20 0C                  794 	jr	nz,ch3_effects$
                                    795 
                                    796 	; Set volume or NOP
                                    797 
      0003F9 CB 6F                  798 	bit	5,a
      0003FB 20 01                  799 	jr	nz,ch3_just_set_volume$
                                    800 
                                    801 	; NOP
                                    802 
      0003FD C9                     803 	ret
                                    804 
      0003FE                        805 ch3_just_set_volume$:
                                    806 
                                    807 	; Set volume
                                    808 
      0003FE CB 37                  809 	swap	a
      000400 EAr02r00               810 	ld	(gbt_vol+2),a
                                    811 
      000403 18 3D                  812 	jr	refresh_channel3_regs$
                                    813 
      000405                        814 ch3_effects$:
                                    815 
                                    816 	; Set effect
                                    817 
      000405 E6 0F                  818 	and	a,#0x0F ; a = effect
                                    819 
      000407 CDrEEr04               820 	call	gbt_channel_3_set_effect
      00040A A7                     821 	and	a,a
      00040B C8                     822 	ret	z ; if 0, don't refresh registers
                                    823 
      00040C 18 34                  824 	jr	refresh_channel3_regs$
                                    825 
      00040E                        826 ch3_has_frequency$:
                                    827 
                                    828 	; Has frequency
                                    829 
      00040E E6 7F                  830 	and	a,#0x7F
      000410 EAr06r00               831 	ld	(gbt_arpeggio_freq_index+2*3),a
                                    832 	; This destroys hl and a. Returns freq in bc
      000413 CDr20r01               833 	call	_gbt_get_freq_from_index
                                    834 
      000416 79                     835 	ld	a,c
      000417 EAr04r00               836 	ld	(gbt_freq+2*2+0),a
      00041A 78                     837 	ld	a,b
      00041B EAr05r00               838 	ld	(gbt_freq+2*2+1),a ; Get frequency
                                    839 
      00041E 1A                     840 	ld	a,(de)
      00041F 13                     841 	inc	de
                                    842 
      000420 CB 7F                  843 	bit	7,a
      000422 20 10                  844 	jr	nz,ch3_freq_instr_and_effect$
                                    845 
                                    846 	; Freq + Instr + Volume
                                    847 
      000424 47                     848 	ld	b,a ; save byte
                                    849 
      000425 E6 0F                  850 	and	a,#0x0F
      000427 EAr02r00               851 	ld	(gbt_instr+2),a ; Instrument
                                    852 
      00042A 78                     853 	ld	a,b ; restore byte
                                    854 
      00042B E6 30                  855 	and	a,#0x30 ; a = volume
      00042D CB 27                  856 	sla	a
      00042F EAr02r00               857 	ld	(gbt_vol+2),a
                                    858 
      000432 18 0E                  859 	jr	refresh_channel3_regs$
                                    860 
      000434                        861 ch3_freq_instr_and_effect$:
                                    862 
                                    863 	; Freq + Instr + Effect
                                    864 
      000434 47                     865 	ld	b,a ; save byte
                                    866 
      000435 E6 0F                  867 	and	a,#0x0F
      000437 EAr02r00               868 	ld	(gbt_instr+2),a ; Instrument
                                    869 
      00043A 78                     870 	ld	a,b ; restore byte
                                    871 
      00043B E6 70                  872 	and	a,#0x70
      00043D CB 37                  873 	swap	a	; a = effect (only 0-7 allowed here)
                                    874 
      00043F CDrEEr04               875 	call	gbt_channel_3_set_effect
                                    876 
                                    877 	;jr	.refresh_channel3_regs
                                    878 
      000442                        879 refresh_channel3_regs$:
                                    880 
                                    881 	; fall through!
                                    882 
                                    883 ; -----------------
                                    884 
      000442                        885 channel3_refresh_registers:
                                    886 
      000442 AF                     887 	xor	a,a
      000443 EA 1A FF               888 	ld	(#.NR30),a ; disable
                                    889 
      000446 FAr00r00               890 	ld	a,(gbt_channel3_loaded_instrument)
      000449 47                     891 	ld	b,a
      00044A FAr02r00               892 	ld	a,(gbt_instr+2)
      00044D B8                     893 	cp	a,b
      00044E C4r6Fr04               894 	call	nz,gbt_channel3_load_instrument ; a = instrument
                                    895 
      000451 3E 80                  896 	ld	a,#0x80
      000453 EA 1A FF               897 	ld	(#.NR30),a ; enable
                                    898 
      000456 AF                     899 	xor	a,a
      000457 EA 1B FF               900 	ld	(#.NR31),a
      00045A FAr02r00               901 	ld	a,(gbt_vol+2)
      00045D EA 1C FF               902 	ld	(#.NR32),a
      000460 FAr04r00               903 	ld	a,(gbt_freq+2*2+0)
      000463 EA 1D FF               904 	ld	(#.NR33),a
      000466 FAr05r00               905 	ld	a,(gbt_freq+2*2+1)
      000469 F6 80                  906 	or	a,#0x80 ; start
      00046B EA 1E FF               907 	ld	(#.NR34),a
                                    908 
      00046E C9                     909 	ret
                                    910 
                                    911 ; ------------------
                                    912 
      00046F                        913 gbt_channel3_load_instrument:
                                    914 
      00046F EAr00r00               915 	ld	(gbt_channel3_loaded_instrument),a
                                    916 
      000472 CB 37                  917 	swap	a ; a = a * 16
      000474 4F                     918 	ld	c,a
      000475 06 00                  919 	ld	b,#0
      000477 21r00r00               920 	ld	hl,#gbt_wave
      00047A 09                     921 	add	hl,bc
                                    922 
      00047B 0E 30                  923 	ld	c,#0x30
      00047D 06 10                  924 	ld	b,#16
      00047F                        925 ch3_loop$:
      00047F 2A                     926 	ld	a,(hl+)
      000480 E2                     927 	ldh	(c),a
      000481 0C                     928 	inc	c
      000482 05                     929 	dec	b
      000483 20 FA                  930 	jr	nz,ch3_loop$
                                    931 
      000485 C9                     932 	ret
                                    933 
                                    934 ; ------------------
                                    935 
      000486                        936 channel3_update_effects: ; returns 1 in a if it is needed to update sound regs
                                    937 
                                    938 	; Cut note
                                    939 	; --------
                                    940 
      000486 FAr02r00               941 	ld	a,(gbt_cut_note_tick+2)
      000489 21r00r00               942 	ld	hl,#gbt_ticks_elapsed
      00048C BE                     943 	cp	a,(hl)
      00048D C2rA2r04               944 	jp	nz,ch3_dont_cut$
                                    945 
      000490 3D                     946 	dec	a ; a = 0xFF
      000491 EAr02r00               947 	ld	(gbt_cut_note_tick+2),a ; disable cut note
                                    948 
      000494 3E 80                  949 	ld	a,#0x80
      000496 EA 1A FF               950 	ld	(#.NR30),a ; enable
                                    951 
      000499 AF                     952 	xor	a,a ; vol = 0
      00049A EA 1C FF               953 	ld	(#.NR32),a
      00049D 3E 80                  954 	ld	a,#0x80 ; start
      00049F EA 1E FF               955 	ld	(#.NR34),a
                                    956 
      0004A2                        957 ch3_dont_cut$:
                                    958 
                                    959 	; Arpeggio
                                    960 	; --------
                                    961 
      0004A2 FAr02r00               962 	ld	a,(gbt_arpeggio_enabled+2)
      0004A5 A7                     963 	and	a,a
      0004A6 C8                     964 	ret	z ; a is 0, return 0
                                    965 
                                    966 	; If enabled arpeggio, handle it
                                    967 
      0004A7 FAr02r00               968 	ld	a,(gbt_arpeggio_tick+2)
      0004AA A7                     969 	and	a,a
      0004AB 20 14                  970 	jr	nz,ch3_not_tick_0$
                                    971 
                                    972 	; Tick 0 - Set original frequency
                                    973 
      0004AD FAr06r00               974 	ld	a,(gbt_arpeggio_freq_index+2*3+0)
                                    975 
      0004B0 CDr20r01               976 	call	_gbt_get_freq_from_index
                                    977 
      0004B3 79                     978 	ld	a,c
      0004B4 EAr04r00               979 	ld	(gbt_freq+2*2+0),a
      0004B7 78                     980 	ld	a,b
      0004B8 EAr05r00               981 	ld	(gbt_freq+2*2+1),a ; Set frequency
                                    982 
      0004BB 3E 01                  983 	ld	a,#1
      0004BD EAr02r00               984 	ld	(gbt_arpeggio_tick+2),a
                                    985 
      0004C0 C9                     986 	ret ; ret 1
                                    987 
      0004C1                        988 ch3_not_tick_0$:
                                    989 
      0004C1 FE 01                  990 	cp	a,#1
      0004C3 20 15                  991 	jr	nz,ch3_not_tick_1$
                                    992 
                                    993 	; Tick 1
                                    994 
      0004C5 FAr07r00               995 	ld	a,(gbt_arpeggio_freq_index+2*3+1)
                                    996 
      0004C8 CDr20r01               997 	call	_gbt_get_freq_from_index
                                    998 
      0004CB 79                     999 	ld	a,c
      0004CC EAr04r00              1000 	ld	(gbt_freq+2*2+0),a
      0004CF 78                    1001 	ld	a,b
      0004D0 EAr05r00              1002 	ld	(gbt_freq+2*2+1),a ; Set frequency
                                   1003 
      0004D3 3E 02                 1004 	ld	a,#2
      0004D5 EAr02r00              1005 	ld	(gbt_arpeggio_tick+2),a
                                   1006 
      0004D8 3D                    1007 	dec	a
      0004D9 C9                    1008 	ret ; ret 1
                                   1009 
      0004DA                       1010 ch3_not_tick_1$:
                                   1011 
                                   1012 	; Tick 2
                                   1013 
      0004DA FAr08r00              1014 	ld	a,(gbt_arpeggio_freq_index+2*3+2)
                                   1015 
      0004DD CDr20r01              1016 	call	_gbt_get_freq_from_index
                                   1017 
      0004E0 79                    1018 	ld	a,c
      0004E1 EAr04r00              1019 	ld	(gbt_freq+2*2+0),a
      0004E4 78                    1020 	ld	a,b
      0004E5 EAr05r00              1021 	ld	(gbt_freq+2*2+1),a ; Set frequency
                                   1022 
      0004E8 AF                    1023 	xor	a,a
      0004E9 EAr02r00              1024 	ld	(gbt_arpeggio_tick+2),a
                                   1025 
      0004EC 3C                    1026 	inc	a
      0004ED C9                    1027 	ret ; ret 1
                                   1028 
                                   1029 ; -----------------
                                   1030 
                                   1031 ; returns a = 1 if needed to update registers, 0 if not
      0004EE                       1032 gbt_channel_3_set_effect: ; a = effect, de = pointer to data
                                   1033 
      0004EE 21rFCr04              1034 	ld	hl,#gbt_ch3_jump_table$
      0004F1 4F                    1035 	ld	c,a
      0004F2 06 00                 1036 	ld	b,#0
      0004F4 09                    1037 	add	hl,bc
      0004F5 09                    1038 	add	hl,bc
                                   1039 
      0004F6 2A                    1040 	ld	a,(hl+)
      0004F7 66                    1041 	ld	h,(hl)
      0004F8 6F                    1042 	ld	l,a
                                   1043 
      0004F9 1A                    1044 	ld	a,(de) ; load args
      0004FA 13                    1045 	inc	de
                                   1046 
      0004FB E9                    1047 	jp	(hl)
                                   1048 
      0004FC                       1049 gbt_ch3_jump_table$:
      0004FCr1Cr05                 1050 	.DW	gbt_ch3_pan$
      0004FEr23r05                 1051 	.DW	gbt_ch3_arpeggio$
      000500r3Er05                 1052 	.DW	gbt_ch3_cut_note$
      000502r09r06                 1053 	.DW	gbt_ch1234_nop
      000504r09r06                 1054 	.DW	gbt_ch1234_nop
      000506r09r06                 1055 	.DW	gbt_ch1234_nop
      000508r09r06                 1056 	.DW	gbt_ch1234_nop
      00050Ar09r06                 1057 	.DW	gbt_ch1234_nop
      00050Cr0Br06                 1058 	.DW	gbt_ch1234_jump_pattern
      00050Er1Cr06                 1059 	.DW	gbt_ch1234_jump_position
      000510r2Er06                 1060 	.DW	gbt_ch1234_speed
      000512r09r06                 1061 	.DW	gbt_ch1234_nop
      000514r09r06                 1062 	.DW	gbt_ch1234_nop
      000516r09r06                 1063 	.DW	gbt_ch1234_nop
      000518r09r06                 1064 	.DW	gbt_ch1234_nop
      00051Ar09r06                 1065 	.DW	gbt_ch1234_nop
                                   1066 
      00051C                       1067 gbt_ch3_pan$:
      00051C E6 44                 1068 	and	a,#0x44
      00051E EAr02r00              1069 	ld	(gbt_pan+2),a
      000521 AF                    1070 	xor	a,a ; ret 0
      000522 C9                    1071 	ret ; do not update registers, only NR51 at end.
                                   1072 
      000523                       1073 gbt_ch3_arpeggio$:
      000523 47                    1074 	ld	b,a ; b = params
                                   1075 
      000524 21r06r00              1076 	ld	hl,#gbt_arpeggio_freq_index+2*3
      000527 4E                    1077 	ld	c,(hl) ; c = base index
      000528 23                    1078 	inc	hl
                                   1079 
      000529 78                    1080 	ld	a,b
      00052A CB 37                 1081 	swap	a
      00052C E6 0F                 1082 	and	a,#0x0F
      00052E 81                    1083 	add	a,c
                                   1084 
      00052F 22                    1085 	ld	(hl+),a ; save first increment
                                   1086 
      000530 78                    1087 	ld	a,b
      000531 E6 0F                 1088 	and	a,#0x0F
      000533 81                    1089 	add	a,c
                                   1090 
      000534 77                    1091 	ld	(hl),a ; save second increment
                                   1092 
      000535 3E 01                 1093 	ld	a,#1
      000537 EAr02r00              1094 	ld	(gbt_arpeggio_enabled+2),a
      00053A EAr02r00              1095 	ld	(gbt_arpeggio_tick+2),a
                                   1096 
      00053D C9                    1097 	ret ; ret 1
                                   1098 
      00053E                       1099 gbt_ch3_cut_note$:
      00053E EAr02r00              1100 	ld	(gbt_cut_note_tick+2),a
      000541 AF                    1101 	xor	a,a ; ret 0
      000542 C9                    1102 	ret
                                   1103 
                                   1104 ;-------------------------------------------------------------------------------
                                   1105 ;---------------------------------- Channel 4 ----------------------------------
                                   1106 ;-------------------------------------------------------------------------------
                                   1107 
      000543                       1108 gbt_channel_4_handle:: ; de = info
                                   1109 
      000543 FAr00r00              1110 	ld	a,(gbt_channels_enabled)
      000546 E6 08                 1111 	and	a,#0x08
      000548 20 14                 1112 	jr	nz,channel4_enabled$
                                   1113 
                                   1114 	; Channel is disabled. Increment pointer as needed
                                   1115 
      00054A 1A                    1116 	ld	a,(de)
      00054B 13                    1117 	inc	de
      00054C CB 7F                 1118 	bit	7,a
      00054E 20 06                 1119 	jr	nz,ch4_more_bytes$
      000550 CB 77                 1120 	bit	6,a
      000552 28 09                 1121 	jr	z,ch4_no_more_bytes_this_channel$
                                   1122 
      000554 18 06                 1123 	jr	ch4_one_more_byte$
                                   1124 
      000556                       1125 ch4_more_bytes$:
                                   1126 
      000556 1A                    1127 	ld	a,(de)
      000557 13                    1128 	inc	de
      000558 CB 7F                 1129 	bit	7,a
      00055A 28 01                 1130 	jr	z,ch4_no_more_bytes_this_channel$
                                   1131 
      00055C                       1132 ch4_one_more_byte$:
                                   1133 
      00055C 13                    1134 	inc	de
                                   1135 
      00055D                       1136 ch4_no_more_bytes_this_channel$:
                                   1137 
      00055D C9                    1138 	ret
                                   1139 
      00055E                       1140 channel4_enabled$:
                                   1141 
                                   1142 	; Channel 4 is enabled
                                   1143 
      00055E 1A                    1144 	ld	a,(de)
      00055F 13                    1145 	inc	de
                                   1146 
      000560 CB 7F                 1147 	bit	7,a
      000562 20 1B                 1148 	jr	nz,ch4_has_instrument$
                                   1149 
                                   1150 	; Not instrument
                                   1151 
      000564 CB 77                 1152 	bit	6,a
      000566 20 0E                 1153 	jr	nz,ch4_effects$
                                   1154 
                                   1155 	; Set volume or NOP
                                   1156 
      000568 CB 6F                 1157 	bit	5,a
      00056A 20 01                 1158 	jr	nz,ch4_just_set_volume$
                                   1159 
                                   1160 	; NOP
                                   1161 
      00056C C9                    1162 	ret
                                   1163 
      00056D                       1164 ch4_just_set_volume$:
                                   1165 
                                   1166 	; Set volume
                                   1167 
      00056D E6 0F                 1168 	and	a,#0x0F
      00056F CB 37                 1169 	swap	a
      000571 EAr03r00              1170 	ld	(gbt_vol+3),a
                                   1171 
      000574 18 2A                 1172 	jr	refresh_channel4_regs$
                                   1173 
      000576                       1174 ch4_effects$:
                                   1175 
                                   1176 	; Set effect
                                   1177 
      000576 E6 0F                 1178 	and	a,#0x0F ; a = effect
                                   1179 
      000578 CDrCFr05              1180 	call	gbt_channel_4_set_effect
      00057B A7                    1181 	and	a,a
      00057C C8                    1182 	ret	z ; if 0, don't refresh registers
                                   1183 
      00057D 18 21                 1184 	jr	refresh_channel4_regs$
                                   1185 
      00057F                       1186 ch4_has_instrument$:
                                   1187 
                                   1188 	; Has instrument
                                   1189 
      00057F E6 1F                 1190 	and	a,#0x1F
      000581 21r80r00              1191 	ld	hl,#gbt_noise
      000584 4F                    1192 	ld	c,a
      000585 06 00                 1193 	ld	b,#0
      000587 09                    1194 	add	hl,bc
      000588 7E                    1195 	ld	a,(hl) ; a = instrument data
                                   1196 
      000589 EAr03r00              1197 	ld	(gbt_instr+3),a
                                   1198 
      00058C 1A                    1199 	ld	a,(de)
      00058D 13                    1200 	inc	de
                                   1201 
      00058E CB 7F                 1202 	bit	7,a
      000590 20 09                 1203 	jr	nz,ch4_instr_and_effect$
                                   1204 
                                   1205 	; Instr + Volume
                                   1206 
      000592 E6 0F                 1207 	and	a,#0x0F ; a = volume
                                   1208 
      000594 CB 37                 1209 	swap	a
      000596 EAr03r00              1210 	ld	(gbt_vol+3),a
                                   1211 
      000599 18 05                 1212 	jr	refresh_channel4_regs$
                                   1213 
      00059B                       1214 ch4_instr_and_effect$:
                                   1215 
                                   1216 	; Instr + Effect
                                   1217 
      00059B E6 0F                 1218 	and	a,#0x0F ; a = effect
                                   1219 
      00059D CDrCFr05              1220 	call	gbt_channel_4_set_effect
                                   1221 
                                   1222 	;jr	ch4_refresh_channel4_regs$
                                   1223 
      0005A0                       1224 refresh_channel4_regs$:
                                   1225 
                                   1226 	; fall through!
                                   1227 
                                   1228 ; -----------------
                                   1229 
      0005A0                       1230 channel4_refresh_registers:
                                   1231 
      0005A0 AF                    1232 	xor	a,a
      0005A1 EA 20 FF              1233 	ld	(#.NR41),a
      0005A4 FAr03r00              1234 	ld	a,(gbt_vol+3)
      0005A7 EA 21 FF              1235 	ld	(#.NR42),a
      0005AA FAr03r00              1236 	ld	a,(gbt_instr+3)
      0005AD EA 22 FF              1237 	ld	(#.NR43),a
      0005B0 3E 80                 1238 	ld	a,#0x80 ; start
      0005B2 EA 23 FF              1239 	ld	(#.NR44),a
                                   1240 
      0005B5 C9                    1241 	ret
                                   1242 
                                   1243 ; ------------------
                                   1244 
      0005B6                       1245 channel4_update_effects: ; returns 1 in a if it is needed to update sound regs
                                   1246 
                                   1247 	; Cut note
                                   1248 	; --------
                                   1249 
      0005B6 FAr03r00              1250 	ld	a,(gbt_cut_note_tick+3)
      0005B9 21r00r00              1251 	ld	hl,#gbt_ticks_elapsed
      0005BC BE                    1252 	cp	a,(hl)
      0005BD C2rCDr05              1253 	jp	nz,ch4_dont_cut$
                                   1254 
      0005C0 3D                    1255 	dec	a ; a = 0xFF
      0005C1 EAr03r00              1256 	ld	(gbt_cut_note_tick+3),a ; disable cut note
                                   1257 
      0005C4 AF                    1258 	xor	a,a ; vol = 0
      0005C5 EA 21 FF              1259 	ld	(#.NR42),a
      0005C8 3E 80                 1260 	ld	a,#0x80 ; start
      0005CA EA 23 FF              1261 	ld	(#.NR44),a
                                   1262 
      0005CD                       1263 ch4_dont_cut$:
                                   1264 
      0005CD AF                    1265 	xor	a,a
      0005CE C9                    1266 	ret ; a is 0, return
                                   1267 
                                   1268 ; -----------------
                                   1269 
                                   1270 ; returns a = 1 if needed to update registers, 0 if not
      0005CF                       1271 gbt_channel_4_set_effect: ; a = effect, de = pointer to data
                                   1272 
      0005CF 21rDDr05              1273 	ld	hl,#gbt_ch4_jump_table$
      0005D2 4F                    1274 	ld	c,a
      0005D3 06 00                 1275 	ld	b,#0
      0005D5 09                    1276 	add	hl,bc
      0005D6 09                    1277 	add	hl,bc
                                   1278 
      0005D7 2A                    1279 	ld	a,(hl+)
      0005D8 66                    1280 	ld	h,(hl)
      0005D9 6F                    1281 	ld	l,a
                                   1282 
      0005DA 1A                    1283 	ld	a,(de) ; load args
      0005DB 13                    1284 	inc	de
                                   1285 
      0005DC E9                    1286 	jp	(hl)
                                   1287 
      0005DD                       1288 gbt_ch4_jump_table$:
      0005DDrFDr05                 1289 	.DW	gbt_ch4_pan$
      0005DFr09r06                 1290 	.DW	gbt_ch1234_nop ; gbt_ch4_arpeggio
      0005E1r04r06                 1291 	.DW	gbt_ch4_cut_note$
      0005E3r09r06                 1292 	.DW	gbt_ch1234_nop
      0005E5r09r06                 1293 	.DW	gbt_ch1234_nop
      0005E7r09r06                 1294 	.DW	gbt_ch1234_nop
      0005E9r09r06                 1295 	.DW	gbt_ch1234_nop
      0005EBr09r06                 1296 	.DW	gbt_ch1234_nop
      0005EDr0Br06                 1297 	.DW	gbt_ch1234_jump_pattern
      0005EFr1Cr06                 1298 	.DW	gbt_ch1234_jump_position
      0005F1r2Er06                 1299 	.DW	gbt_ch1234_speed
      0005F3r09r06                 1300 	.DW	gbt_ch1234_nop
      0005F5r09r06                 1301 	.DW	gbt_ch1234_nop
      0005F7r09r06                 1302 	.DW	gbt_ch1234_nop
      0005F9r09r06                 1303 	.DW	gbt_ch1234_nop
      0005FBr09r06                 1304 	.DW	gbt_ch1234_nop
                                   1305 
      0005FD                       1306 gbt_ch4_pan$:
      0005FD E6 88                 1307 	and	a,#0x88
      0005FF EAr03r00              1308 	ld	(gbt_pan+3),a
      000602 AF                    1309 	xor	a,a ; ret 0
      000603 C9                    1310 	ret ; do not update registers, only NR51 at end.
                                   1311 
      000604                       1312 gbt_ch4_cut_note$:
      000604 EAr03r00              1313 	ld	(gbt_cut_note_tick+3),a
      000607 AF                    1314 	xor	a,a ; ret 0
      000608 C9                    1315 	ret
                                   1316 
                                   1317 ;-------------------------------------------------------------------------------
                                   1318 
                                   1319 ; Common effects go here:
                                   1320 
      000609                       1321 gbt_ch1234_nop:
      000609 AF                    1322 	xor	a,a ;ret 0
      00060A C9                    1323 	ret
                                   1324 
      00060B                       1325 gbt_ch1234_jump_pattern:
      00060B EAr00r00              1326 	ld	(gbt_current_pattern),a
      00060E AF                    1327 	xor	a,a
      00060F EAr00r00              1328 	ld	(gbt_current_step),a
      000612 EAr00r00              1329 	ld	(gbt_have_to_stop_next_step),a ; clear stop flag
      000615 3E 01                 1330 	ld	a,#1
      000617 EAr00r00              1331 	ld	(gbt_update_pattern_pointers),a
      00061A AF                    1332 	xor	a,a ;ret 0
      00061B C9                    1333 	ret
                                   1334 
      00061C                       1335 gbt_ch1234_jump_position:
      00061C EAr00r00              1336 	ld	(gbt_current_step),a
      00061F 21r00r00              1337 	ld	hl,#gbt_current_pattern
      000622 34                    1338 	inc	(hl)
                                   1339 
                                   1340 	; Check to see if jump puts us past end of song
      000623 7E                    1341 	ld	a,(hl)
      000624 CDr00r00              1342 	call	gbt_get_pattern_ptr_banked
      000627 3E 01                 1343 	ld	a,#1 ; tell gbt_player.s to do this next cycle
      000629 EAr00r00              1344 	ld	(gbt_update_pattern_pointers),a
      00062C AF                    1345 	xor	a,a ;ret 0
      00062D C9                    1346 	ret
                                   1347 
      00062E                       1348 gbt_ch1234_speed:
      00062E EAr00r00              1349 	ld	(gbt_speed),a
      000631 AF                    1350 	xor	a,a
      000632 EAr00r00              1351 	ld	(gbt_ticks_elapsed),a
      000635 C9                    1352 	ret ;ret 0
                                   1353 
                                   1354 ;-------------------------------------------------------------------------------
                                   1355 
      000636                       1356 gbt_update_bank1::
                                   1357 
      000636 11r00r00              1358 	ld	de,#gbt_temp_play_data
                                   1359 
                                   1360 	; each function will return in de the pointer to next byte
                                   1361 
      000639 CDr2Cr01              1362 	call	gbt_channel_1_handle
                                   1363 
      00063C CDr82r02              1364 	call	gbt_channel_2_handle
                                   1365 
      00063F CDrD4r03              1366 	call	gbt_channel_3_handle
                                   1367 
      000642 CDr43r05              1368 	call	gbt_channel_4_handle
                                   1369 
                                   1370 	; end of channel handling
                                   1371 
      000645 21r00r00              1372 	ld	hl,#gbt_pan
      000648 2A                    1373 	ld	a,(hl+)
      000649 B6                    1374 	or	a,(hl)
      00064A 23                    1375 	inc	hl
      00064B B6                    1376 	or	a,(hl)
      00064C 23                    1377 	inc hl
      00064D B6                    1378 	or	a,(hl)
      00064E EA 25 FF              1379 	ld	(#.NR51),a ; handle panning...
                                   1380 
      000651 C9                    1381 	ret
                                   1382 
                                   1383 ;-------------------------------------------------------------------------------
                                   1384 
      000652                       1385 gbt_update_effects_bank1::
                                   1386 
      000652 CDrCAr01              1387 	call	channel1_update_effects
      000655 A7                    1388 	and	a,a
      000656 C4rABr01              1389 	call	nz,channel1_refresh_registers
                                   1390 
      000659 CDr1Cr03              1391 	call	channel2_update_effects
      00065C A7                    1392 	and	a,a
      00065D C4r01r03              1393 	call	nz,channel2_refresh_registers
                                   1394 
      000660 CDr86r04              1395 	call	channel3_update_effects
      000663 A7                    1396 	and	a,a
      000664 C4r42r04              1397 	call	nz,channel3_refresh_registers
                                   1398 
      000667 CDrB6r05              1399 	call	channel4_update_effects
      00066A A7                    1400 	and	a,a
      00066B C4rA0r05              1401 	call	nz,channel4_refresh_registers
                                   1402 
      00066E C9                    1403 	ret
                                   1404 
                                   1405 ;-------------------------------------------------------------------------------
